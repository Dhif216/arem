import{j as e,_ as Z}from"./index-DZ1YfwEg.js";import{r as i,e as ee}from"./react-vendor-BgZu1yuc.js";import{a as q,b as te,u as E,c as se,d as A,e as re,f as j,g as ae,h as ne}from"./productsService-6ZmkCUqg.js";import{M as z}from"./products-0_iZlxnD.js";import{u as ie}from"./i18n-vendor-DSlEIxXL.js";const me=()=>{const[u,R]=i.useState([]),[w,v]=i.useState(!0),[p,_]=i.useState(null),[x,b]=i.useState(!1),[h,l]=i.useState(!1),[f,k]=i.useState(!1),[C,N]=i.useState(null),[m,r]=i.useState(null),[P,D]=i.useState(""),[y,U]=i.useState(""),[I,$]=i.useState(""),[K,L]=i.useState(""),[M,V]=i.useState(""),O=ee(),{t:d}=ie(),[n,o]=i.useState({nameFr:"",nameTn:"",descriptionFr:"",descriptionTn:"",price:"",category:"honeyed",image:"",featured:!1});i.useEffect(()=>{q(j).then(t=>{$(`Session anonyme active (UID: ${t.user?.uid?.slice(0,8)||"inconnu"})`)}).catch(t=>{console.warn("Anonymous auth failed (may be disabled):",t),U("Authentification anonyme d√©sactiv√©e. Activez-la dans Firebase Auth pour autoriser les t√©l√©versements.")}),v(!0),D("");try{const t=te(a=>{console.log("Received products from Firestore:",a.length),R(a),v(!1)});return()=>{t()}}catch(t){console.error("Failed to subscribe to products:",t),D("Impossible de charger les produits. V√©rifiez la console."),v(!1)}},[]);const H=()=>{localStorage.removeItem("adminAuth"),localStorage.removeItem("adminUsername"),O("/admin/login")},W=async t=>{t.preventDefault(),l(!0),r(null);const a={slug:re(n.nameFr||`produit-${Date.now()}`),category:n.category,price:parseFloat(n.price),image:n.image,name_fr:n.nameFr,name_tn:n.nameTn,desc_fr:n.descriptionFr,desc_tn:n.descriptionTn,featured:n.featured};try{p?.id?(await E(p.id,a),r({type:"success",text:"Produit mis √† jour avec succ√®s!"})):(await A(a),r({type:"success",text:"Produit ajout√© avec succ√®s!"})),setTimeout(()=>{S(),r(null)},2e3)}catch{r({type:"error",text:"Erreur lors de l'enregistrement du produit"})}finally{l(!1)}},G=t=>{_(t),o({nameFr:t.name_fr,nameTn:t.name_tn,descriptionFr:t.desc_fr,descriptionTn:t.desc_tn,price:t.price.toString(),category:t.category,image:t.image,featured:t.featured||!1}),b(!0)},J=async t=>{if(t&&confirm("D√©sactiver ce produit? Il ne sera plus visible dans la boutique, mais vous pourrez le restaurer plus tard.")){r(null);try{await ae(t),r({type:"success",text:"Produit d√©sactiv√© avec succ√®s!"}),setTimeout(()=>r(null),3e3)}catch{r({type:"error",text:"Erreur lors de la d√©sactivation du produit"})}}},B=async t=>{if(t.id&&confirm("Supprimer D√âFINITIVEMENT ce produit et son image ? Cette action est irr√©versible.")){r(null),l(!0);try{await ne(t.id,t.image),p?.id===t.id&&S(),r({type:"success",text:"Produit et image supprim√©s d√©finitivement."}),setTimeout(()=>r(null),3e3)}catch{r({type:"error",text:"Erreur lors de la suppression d√©finitive."})}finally{l(!1)}}},Q=async t=>{if(t){r(null);try{await E(t,{active:!0}),r({type:"success",text:"Produit restaur√© avec succ√®s!"}),setTimeout(()=>r(null),3e3)}catch{r({type:"error",text:"Erreur lors de la restauration du produit"})}}},S=()=>{o({nameFr:"",nameTn:"",descriptionFr:"",descriptionTn:"",price:"",category:"honeyed",image:"",featured:!1}),_(null),b(!1)},X=async()=>{if(j.currentUser)return j.currentUser;try{const t=await q(j);return $(`Session anonyme active (UID: ${t.user?.uid?.slice(0,8)||"inconnu"})`),t.user}catch(t){throw U("Impossible de d√©marrer une session anonyme. V√©rifiez Auth ‚Üí Anonymous et domaines autoris√©s."),t}},Y=async()=>{l(!0),r(null);try{const t=new Set(u.map(s=>s.slug)),a=z.filter(s=>!t.has(s.slug));if(a.length===0)r({type:"success",text:"Aucun produit manquant √† importer."}),setTimeout(()=>r(null),2500);else{for(const s of a){const c=d(`products.${s.nameKey}`,{lng:"fr"}),T=d(`products.${s.nameKey}`,{lng:"tn"}),g=d(`products.${s.descriptionKey}`,{lng:"fr"}),F=d(`products.${s.descriptionKey}`,{lng:"tn"});await A({slug:s.slug,category:s.category,price:s.price,image:s.image,name_fr:c||s.slug,name_tn:T||c||s.slug,desc_fr:g||"",desc_tn:F||g||"",featured:!1})}r({type:"success",text:`Importation r√©ussie: ${a.length} produit(s) ajout√©(s).`}),setTimeout(()=>r(null),3e3)}}catch(t){console.error("Import missing error:",t),r({type:"error",text:"Erreur lors de l'import."})}finally{l(!1)}};return e.jsxs("div",{className:"admin-dashboard",children:[e.jsx("header",{className:"admin-header",children:e.jsxs("div",{className:"admin-header-content",children:[e.jsx("h1",{children:"üç∞ Admin Dashboard"}),e.jsxs("div",{className:"admin-user-info",children:[e.jsxs("span",{children:["üë§ ",localStorage.getItem("adminUsername")]}),e.jsx("button",{onClick:H,className:"logout-btn",children:"D√©connexion"})]})]})}),e.jsxs("div",{className:"admin-content",children:[y&&e.jsx("div",{className:"status-message error",style:{marginBottom:12},children:y}),!y&&I&&e.jsx("div",{className:"status-message success",style:{marginBottom:12},children:I}),e.jsxs("div",{className:"admin-actions",children:[e.jsx("button",{onClick:()=>b(!x),className:"add-product-btn",children:x?"‚úñ Annuler":"‚ûï Ajouter un produit"}),e.jsx("button",{onClick:Y,className:"add-product-btn",disabled:h,style:{background:"#654321"},title:"Importer les produits par d√©faut manquants",children:"üì¶ Importer manquants"}),e.jsxs("div",{className:"product-count",children:["Total: ",e.jsx("strong",{children:u.length})," produits"]})]}),u.some(t=>t.active!==!0)&&e.jsx("div",{style:{margin:"10px 0"},children:e.jsx("button",{className:"edit-btn",disabled:h,onClick:async()=>{const t=u.filter(a=>a.id&&a.active!==!0);if(t.length!==0){l(!0);try{for(const a of t)await E(a.id,{active:!0});r({type:"success",text:`Activ√©s: ${t.length} produit(s).`})}catch{r({type:"error",text:"Erreur lors de l'activation en masse."})}finally{l(!1),setTimeout(()=>r(null),3e3)}}},title:"Forcer tous les produits √† √™tre actifs",children:"‚úÖ Activer tous les produits"})}),e.jsxs("div",{style:{background:"#222",color:"#ddd",padding:"10px",borderRadius:6,marginBottom:18,fontSize:"0.85rem"},children:[e.jsx("strong",{children:"Diagnostics Storage"}),e.jsx("br",{}),"Bucket: ",e.jsx("code",{children:"tunisian-sweets-3d860.firebasestorage.app"}),e.jsx("br",{}),"Auth: ",I||(y?"Erreur auth":"‚Äî"),e.jsx("br",{}),"Dernier upload: ",M?e.jsx("a",{href:M,target:"_blank",rel:"noopener noreferrer",style:{color:"#4eaaff"},children:"ouvrir"}):"‚Äî",e.jsx("br",{}),"Erreur upload: ",K||"‚Äî"]}),x&&e.jsxs("div",{className:"product-form-container",children:[e.jsx("h2",{children:p?"Modifier le produit":"Nouveau produit"}),m&&e.jsx("div",{className:`status-message ${m.type}`,children:m.text}),e.jsxs("form",{onSubmit:W,className:"product-form",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nom (Fran√ßais) *"}),e.jsx("input",{type:"text",value:n.nameFr,onChange:t=>o({...n,nameFr:t.target.value}),required:!0,placeholder:"Ex: Makroud"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nom (Arabe) *"}),e.jsx("input",{type:"text",value:n.nameTn,onChange:t=>o({...n,nameTn:t.target.value}),required:!0,placeholder:"Ex: ŸÖŸÇÿ±Ÿàÿ∂",dir:"rtl"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description (Fran√ßais) *"}),e.jsx("textarea",{value:n.descriptionFr,onChange:t=>o({...n,descriptionFr:t.target.value}),required:!0,rows:3,placeholder:"Description en fran√ßais"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description (Arabe) *"}),e.jsx("textarea",{value:n.descriptionTn,onChange:t=>o({...n,descriptionTn:t.target.value}),required:!0,rows:3,placeholder:"ÿßŸÑŸàÿµŸÅ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©",dir:"rtl"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Prix (TND) *"}),e.jsx("input",{type:"number",step:"0.01",value:n.price,onChange:t=>o({...n,price:t.target.value}),required:!0,placeholder:"Ex: 12.50"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Cat√©gorie *"}),e.jsxs("select",{value:n.category,onChange:t=>o({...n,category:t.target.value}),required:!0,children:[e.jsx("option",{value:"honeyed",children:"Honeyed"}),e.jsx("option",{value:"dry",children:"Dry"}),e.jsx("option",{value:"seasonal",children:"Seasonal"}),e.jsx("option",{value:"other",children:"Other"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Image du produit *"}),e.jsxs("div",{className:"image-upload-container",children:[e.jsxs("div",{className:"upload-options",children:[e.jsx("button",{type:"button",className:"upload-tab",onClick:()=>document.getElementById("imageFileInput")?.click(),disabled:f,children:f?"‚è≥ T√©l√©versement...":"üìÅ T√©l√©charger depuis l'appareil"}),e.jsx("span",{style:{margin:"0 10px",color:"#999"},children:"ou"}),e.jsx("input",{type:"text",value:n.image,onChange:t=>o({...n,image:t.target.value}),placeholder:"Entrer une URL d'image",style:{flex:1}})]}),e.jsx("input",{id:"imageFileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:async t=>{const a=t.target.files?.[0];if(a){if(!a.type.startsWith("image/")){r({type:"error",text:"Veuillez s√©lectionner un fichier image valide"});return}if(a.size>5*1024*1024){r({type:"error",text:"Image trop grande. Maximum 5MB."});return}k(!0),N(0),r(null);try{await X(),console.log("Uploading image:",a.name,a.type,a.size);const{url:s}=await se(a,c=>N(c));console.log("Image uploaded, URL:",s),V(s),o({...n,image:s}),r({type:"success",text:"Image t√©l√©vers√©e avec succ√®s!"}),setTimeout(()=>r(null),3e3)}catch(s){console.error("Upload error:",s);const c=s instanceof Error?s.message:"T√©l√©versement √©chou√©";L(c),r({type:"error",text:`Erreur: ${c}`})}finally{k(!1),N(null),t.target.value=""}}}}),e.jsx("div",{className:"image-preview",children:f?e.jsxs("div",{className:"image-placeholder",children:["‚è≥ T√©l√©versement de l'image... ",C!==null?`${C}%`:""]}):n.image?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[e.jsx("img",{src:n.image,alt:"Preview",style:{maxHeight:200},onError:t=>{t.target.src="https://via.placeholder.com/200x200?text=Image+Error"}}),e.jsx("button",{type:"button",className:"delete-btn",title:"Supprimer l'image du stockage",onClick:async()=>{if(confirm("Supprimer l'image du stockage et vider ce champ ?"))try{l(!0);const{deleteImageByUrl:t}=await Z(async()=>{const{deleteImageByUrl:a}=await import("./productsService-6ZmkCUqg.js").then(s=>s.p);return{deleteImageByUrl:a}},[]);await t(n.image),o({...n,image:""}),r({type:"success",text:"Image supprim√©e du stockage."}),setTimeout(()=>r(null),2500)}catch{r({type:"error",text:"Impossible de supprimer l'image."})}finally{l(!1)}},children:"üßπ Supprimer l'image"})]}):e.jsx("div",{className:"image-placeholder",children:"Aucun aper√ßu pour le moment"})})]})]}),e.jsx("div",{className:"form-group checkbox-group",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:n.featured,onChange:t=>o({...n,featured:t.target.checked})}),"Produit vedette"]})}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"submit",className:"submit-btn",disabled:h||f,children:h?"‚è≥ Enregistrement...":p?"üíæ Mettre √† jour":"‚ûï Ajouter"}),e.jsx("button",{type:"button",onClick:S,className:"cancel-btn",disabled:h,children:"Annuler"})]})]})]}),e.jsxs("div",{className:"products-list",children:[e.jsx("h2",{children:"Liste des produits"}),P&&e.jsx("div",{className:"status-message error",children:P}),m&&!x&&e.jsx("div",{className:`status-message ${m.type}`,children:m.text}),w&&e.jsx("div",{className:"loading-indicator",children:"Chargement des produits..."}),e.jsx("div",{className:"products-table-container",children:e.jsxs("table",{className:"products-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Image"}),e.jsx("th",{children:"Nom"}),e.jsx("th",{children:"Cat√©gorie"}),e.jsx("th",{children:"Prix"}),e.jsx("th",{children:"Vedette"}),e.jsx("th",{children:"Statut"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:!w&&u.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:6,className:"no-products",children:["Aucun produit. Ajoutez votre premier produit ou importez la liste par d√©faut.",e.jsx("div",{style:{marginTop:12},children:e.jsx("button",{className:"add-product-btn",onClick:async()=>{try{l(!0);const t=new Set(u.map(s=>s.slug)),a=z.filter(s=>!t.has(s.slug));for(const s of a){const c=d(`products.${s.nameKey}`,{lng:"fr"}),T=d(`products.${s.nameKey}`,{lng:"tn"}),g=d(`products.${s.descriptionKey}`,{lng:"fr"}),F=d(`products.${s.descriptionKey}`,{lng:"tn"});await A({slug:s.slug,category:s.category,price:s.price,image:s.image,name_fr:c||s.slug,name_tn:T||c||s.slug,desc_fr:g||"",desc_tn:F||g||"",featured:!1})}r({type:"success",text:`Importation termin√©e: ${a.length} produits.`}),setTimeout(()=>r(null),3e3)}catch(t){console.error("Import error:",t),r({type:"error",text:"Erreur d'importation."})}finally{l(!1)}},children:"üì¶ Importer la liste par d√©faut (20)"})})]})}):u.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("img",{src:t.image,alt:t.name_fr,className:"product-thumb"})}),e.jsx("td",{children:e.jsxs("div",{className:"product-names",children:[e.jsx("div",{children:t.name_fr}),e.jsx("div",{className:"product-name-ar",children:t.name_tn})]})}),e.jsx("td",{children:e.jsx("span",{className:"category-badge",children:t.category})}),e.jsx("td",{children:e.jsxs("strong",{children:[t.price.toFixed(2)," TND"]})}),e.jsx("td",{children:t.featured?"‚≠ê":"-"}),e.jsx("td",{children:t.active?"‚úÖ Actif":"‚õî Inactif"}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{onClick:()=>G(t),className:"edit-btn",title:"Modifier",children:"‚úèÔ∏è"}),t.active?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>J(t.id),className:"delete-btn",title:"D√©sactiver",children:"üóëÔ∏è"}),e.jsx("button",{onClick:()=>B(t),className:"delete-btn",title:"Supprimer d√©finitivement",style:{background:"#8b0000"},children:"‚úñ"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Q(t.id),className:"edit-btn",title:"Restaurer",children:"‚ôªÔ∏è"}),e.jsx("button",{onClick:()=>B(t),className:"delete-btn",title:"Supprimer d√©finitivement",style:{background:"#8b0000"},children:"‚úñ"})]})]})})]},t.id))})]})})]})]})]})};export{me as default};
